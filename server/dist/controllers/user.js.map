{"version":3,"sources":["../../src/controllers/user.js"],"names":["UsersController","signup","req","res","User","create","username","body","password","hashSync","email","fullname","role","level","then","status","json","user","catch","send","err","login","next","authenticate","borrow","userId","parseInt","params","bookId","Book","findById","book","bookData","serialize","JSON","stringify","Inventory","inventory","query","returned","findAll","where","return","books","returnBook","inventoryId","update"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AAEA;;;;;;AAEA,IAAMA,kBAAkB;AACpB;AACAC,YAAQ,gBAACC,GAAD,EAAMC,GAAN,EAAc;AAClB,yBAAGC,IAAH,CACKC,MADL,CACY;AACJC,sBAAUJ,IAAIK,IAAJ,CAASD,QADf;AAEJE,sBAAU,mBAAOC,QAAP,CAAgBP,IAAIK,IAAJ,CAASC,QAAzB,EAAmC,CAAnC,CAFN;AAGJE,mBAAOR,IAAIK,IAAJ,CAASG,KAHZ;AAIJC,sBAAUT,IAAIK,IAAJ,CAASI,QAJf;AAKJC,kBAAMV,IAAIK,IAAJ,CAASK,IALX;AAMJC,mBAAOX,IAAIK,IAAJ,CAASM;AANZ,SADZ,EASKC,IATL,CASU;AAAA,mBAAQX,IAAIY,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBC,IAArB,CAAR;AAAA,SATV,EAUKC,KAVL,CAUW;AAAA,mBAAOf,IAAIY,MAAJ,CAAW,GAAX,EAAgBI,IAAhB,CAAqBC,GAArB,CAAP;AAAA,SAVX;AAWH,KAdmB;;AAgBpB;AACAC,WAAO,eAACnB,GAAD,EAAMC,GAAN,EAAWmB,IAAX,EAAoB;AACvB,2BAASC,YAAT,CAAsB,OAAtB,EAA+B,UAACH,GAAD,EAAMH,IAAN,EAAe;AAC1C,gBAAIG,GAAJ,EAAS,OAAOE,KAAKF,GAAL,CAAP;AACT,gBAAI,CAACH,IAAL,EAAW;AACP,uBAAOd,IAAIY,MAAJ,CAAW,GAAX,EAAgBI,IAAhB,CAAqB;AACxBJ,4BAAQ;AADgB,iBAArB,CAAP;AAGH;AACDb,gBAAImB,KAAJ,CAAUJ,IAAV,EAAgB,UAACG,GAAD,EAAS;AACrB,oBAAIA,GAAJ,EAAS,OAAOE,KAAKF,GAAL,CAAP;AACT,uBAAOjB,IAAIY,MAAJ,CAAW,GAAX,EAAgBI,IAAhB,CAAqBF,IAArB,CAAP;AACH,aAHD;AAIH,SAXD,EAWGf,GAXH,EAWQC,GAXR,EAWamB,IAXb;AAYH,KA9BmB;;AAgCpB;AACAE,YAAQ,gBAACtB,GAAD,EAAMC,GAAN,EAAc;AAClB,YAAI,CAACD,IAAIe,IAAT,EAAe,OAAOd,IAAIY,MAAJ,CAAW,GAAX,EAAgBI,IAAhB,CAAqB,cAArB,CAAP;AACf,YAAMM,SAASC,SAASxB,IAAIyB,MAAJ,CAAWF,MAApB,EAA4B,EAA5B,CAAf;AACA,YAAMG,SAAS1B,IAAIK,IAAJ,CAASqB,MAAxB;;AAEA,yBAAGC,IAAH,CACKC,QADL,CACcF,MADd,EAEKd,IAFL,CAEU,UAACiB,IAAD,EAAU;AACZ,gBAAMC,WAAW,qBAAGC,SAAH,CAAaC,KAAKC,SAAL,CAAeJ,IAAf,CAAb,CAAjB;AACA,6BAAGK,SAAH,CACK/B,MADL,CACY;AACJoB,8BADI;AAEJM,sBAAMC;AAFF,aADZ,EAKKlB,IALL,CAKU,UAACuB,SAAD,EAAe;AACjBlC,oBAAIY,MAAJ,CAAW,GAAX,EAAgBI,IAAhB,CAAqBkB,SAArB;AACH,aAPL;AAQH,SAZL,EAaKnB,KAbL,CAaW;AAAA,mBAAOf,IAAIY,MAAJ,CAAW,GAAX,EAAgBI,IAAhB,CAAqBC,GAArB,CAAP;AAAA,SAbX;AAcH,KApDmB;;AAsDpB;AACAiB,eAAW,mBAACnC,GAAD,EAAMC,GAAN,EAAc;AACrB,YAAI,CAACD,IAAIe,IAAT,EAAe,OAAOd,IAAIY,MAAJ,CAAW,GAAX,EAAgBI,IAAhB,CAAqB,cAArB,CAAP;AACf,YAAIjB,IAAIoC,KAAJ,CAAUC,QAAd,EAAwB;AACpB,6BAAGH,SAAH,CACKI,OADL,CACa;AACLC,uBAAO;AACHhB,4BAAQvB,IAAIyB,MAAJ,CAAWF,MADhB;AAEHiB,4BAAQxC,IAAIoC,KAAJ,CAAUC;AAFf;AADF,aADb,EAOKzB,IAPL,CAOU,UAAC6B,KAAD,EAAW;AAAExC,oBAAIgB,IAAJ,CAASwB,KAAT;AAAkB,aAPzC,EAQKzB,KARL,CAQW,UAACE,GAAD,EAAS;AAAEjB,oBAAIgB,IAAJ,CAASC,GAAT;AAAgB,aARtC;AASH;AACD,eAAO,iBAAGgB,SAAH,CACFI,OADE,CACM,EAAEC,OAAO,EAAEhB,QAAQvB,IAAIyB,MAAJ,CAAWF,MAArB,EAAT,EADN,EAEFX,IAFE,CAEG,UAAC6B,KAAD,EAAW;AAAExC,gBAAIgB,IAAJ,CAASwB,KAAT;AAAkB,SAFlC,EAGFzB,KAHE,CAGI,UAACE,GAAD,EAAS;AAAEjB,gBAAIgB,IAAJ,CAASC,GAAT;AAAgB,SAH/B,CAAP;AAIH,KAxEmB;;AA0EpB;AACAwB,gBAAY,oBAAC1C,GAAD,EAAMC,GAAN,EAAc;AACtB,YAAI,CAACD,IAAIe,IAAT,EAAe,OAAOd,IAAIY,MAAJ,CAAW,GAAX,EAAgBI,IAAhB,CAAqB,cAArB,CAAP;AACf,YAAM0B,cAAcnB,SAASxB,IAAIK,IAAJ,CAASsC,WAAlB,EAA+B,EAA/B,CAApB;AACA,yBAAGT,SAAH,CACKN,QADL,CACce,WADd,EAEK/B,IAFL,CAEU,UAACiB,IAAD,EAAU;AACZ,gBAAI,CAACA,IAAL,EAAW;AACP5B,oBAAIY,MAAJ,CAAW,GAAX,EAAgBI,IAAhB,CAAqB,EAAEJ,QAAQ,WAAV,EAArB;AACH;AACDgB,iBACKe,MADL,CACY,EAAEJ,QAAQ,IAAV,EADZ,EAEK5B,IAFL,CAEU,YAAM;AACRX,oBAAIY,MAAJ,CAAW,GAAX,EAAgBI,IAAhB,CAAqB,EAAEJ,QAAQ,SAAV,EAArB;AACH,aAJL,EAKKG,KALL,CAKW;AAAA,uBAAOf,IAAIY,MAAJ,CAAW,GAAX,EAAgBI,IAAhB,CAAqBC,GAArB,CAAP;AAAA,aALX;AAMH,SAZL;AAaH;;AA3FmB,CAAxB;;kBA+FepB,e","file":"user.js","sourcesContent":["import bcrypt from 'bcryptjs';\r\nimport passport from 'passport';\r\nimport _s from 'serialijse';\r\n\r\nimport db from '../models';\r\n\r\nconst UsersController = {\r\n    /* Register / create user account */\r\n    signup: (req, res) => {\r\n        db.User\r\n            .create({\r\n                username: req.body.username,\r\n                password: bcrypt.hashSync(req.body.password, 8),\r\n                email: req.body.email,\r\n                fullname: req.body.fullname,\r\n                role: req.body.role,\r\n                level: req.body.level\r\n            })\r\n            .then(user => res.status(201).json(user))\r\n            .catch(err => res.status(400).send(err));\r\n    },\r\n\r\n    /* Login user */\r\n    login: (req, res, next) => {\r\n        passport.authenticate('local', (err, user) => {\r\n            if (err) return next(err);\r\n            if (!user) {\r\n                return res.status(500).send({\r\n                    status: 'Invalid credentials'\r\n                });\r\n            }\r\n            req.login(user, (err) => {\r\n                if (err) return next(err);\r\n                return res.status(200).send(user);\r\n            });\r\n        })(req, res, next);\r\n    },\r\n\r\n    /* Borrow book */\r\n    borrow: (req, res) => {\r\n        if (!req.user) return res.status(401).send('Unauthorized');\r\n        const userId = parseInt(req.params.userId, 10);\r\n        const bookId = req.body.bookId;\r\n\r\n        db.Book\r\n            .findById(bookId)\r\n            .then((book) => {\r\n                const bookData = _s.serialize(JSON.stringify(book));\r\n                db.Inventory\r\n                    .create({\r\n                        userId,\r\n                        book: bookData\r\n                    })\r\n                    .then((inventory) => {\r\n                        res.status(200).send(inventory);\r\n                    });\r\n            })\r\n            .catch(err => res.status(400).send(err));\r\n    },\r\n\r\n    /* Get books borrowed by user */\r\n    inventory: (req, res) => {\r\n        if (!req.user) return res.status(401).send('Unauthorized');\r\n        if (req.query.returned) {\r\n            db.Inventory\r\n                .findAll({\r\n                    where: {\r\n                        userId: req.params.userId,\r\n                        return: req.query.returned\r\n                    }\r\n                })\r\n                .then((books) => { res.send(books); })\r\n                .catch((err) => { res.send(err); });\r\n        }\r\n        return db.Inventory\r\n            .findAll({ where: { userId: req.params.userId } })\r\n            .then((books) => { res.send(books); })\r\n            .catch((err) => { res.send(err); });\r\n    },\r\n\r\n    /* Return borrowed books */\r\n    returnBook: (req, res) => {\r\n        if (!req.user) return res.status(401).send('Unauthorized');\r\n        const inventoryId = parseInt(req.body.inventoryId, 10);\r\n        db.Inventory\r\n            .findById(inventoryId)\r\n            .then((book) => {\r\n                if (!book) {\r\n                    res.status(404).send({ status: 'Not found' });\r\n                }\r\n                book\r\n                    .update({ return: true })\r\n                    .then(() => {\r\n                        res.status(200).send({ status: 'success' });\r\n                    })\r\n                    .catch(err => res.status(400).send(err));\r\n            });\r\n    }\r\n\r\n};\r\n\r\nexport default UsersController;\r\n"]}